<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è€äºŒæœƒæ™‚å…‰ç›¸ç°¿</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        body { 
            background-color: #e5d3b3; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
            color: #5d4037; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        h2 { margin-top: 10px; letter-spacing: 1px; }
        .hidden-input { display: none; }

        /* æŠ•ç¨¿æŒ‰éˆ• */
        .upload-card-btn {
            background: #fffef0; width: 90%; max-width: 350px;
            padding: 25px 20px; margin-bottom: 15px; border: 2px solid #5d4037;
            text-align: center; cursor: pointer; box-shadow: 6px 6px 0px #5d4037;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .upload-card-btn:active { transform: translate(3px, 3px); box-shadow: 3px 3px 0px #5d4037; }
        .upload-card-btn h4 { margin: 0; font-size: 20px; color: #5d4037; }
        .upload-card-btn span { font-size: 11px; margin-top: 8px; color: #8d6e63; line-height: 1.5; }
        .video-remind { color: #b71c1c; font-weight: bold; }

        #globalStatus { font-size: 12px; margin-bottom: 15px; color: #b71c1c; font-weight: bold; text-align: center; min-height: 18px; line-height: 1.4; white-space: pre-wrap; }

        /* ç›¸ç°¿ç¶²æ ¼ */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 400px; }
        .card { background: #fffef0; padding: 10px; border: 1px solid #5d4037; cursor: pointer; text-align: center; box-shadow: 4px 4px 0px #5d4037; transition: 0.1s; }
        .card:active { transform: scale(0.98); }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        
        .photo-item { background: white; padding: 10px 10px 25px 10px; border: 1px solid #ddd; position: relative; box-shadow: 3px 3px 8px rgba(0,0,0,0.1); cursor: pointer; }
        .photo-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #fafafa; }
        .video-label { position: absolute; top: 10px; left: 10px; right: 10px; aspect-ratio: 1/1; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; z-index: 1; pointer-events: none; }

        /* é è¦½è¦–çª— */
        #viewerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #viewerContent { width: 95%; max-width: 500px; height: 70vh; position: relative; display: flex; align-items: center; justify-content: center; }
        #closeBtn { position: absolute; top: -50px; right: 10px; color: white; font-size: 35px; cursor: pointer; font-weight: bold; padding: 10px; }
        
        .floating-menu { position: fixed; bottom: 25px; right: 20px; display: none; flex-direction: column; gap: 12px; z-index: 999; }
        .fab { width: 55px; height: 55px; border-radius: 50%; background: #5d4037; color: #e5d3b3; border: 2px solid #e5d3b3; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <h2 id="pageTitle">ğŸï¸ å¤§è€äºŒæœƒæ™‚å…‰ç›¸ç°¿</h2>
    <span id="userName" style="display:none;">è¨ªå®¢</span>
    
    <div id="globalStatus"></div>

    <div class="upload-card-btn" onclick="document.getElementById('unifiedInput').click()">
        <h4>ğŸ“¸ æŠ•ç¨¿ç…§ç‰‡</h4>
        <span>æ”¯æ´å¤šå¼µç…§ç‰‡é¸æ“‡<br>ç³»çµ±è‡ªå‹•è™•ç† iPhone æ ¼å¼<br><span class="video-remind">âš ï¸ å½±ç‰‡è«‹ç›´æ¥å‚³è‡³ç¾¤çµ„ç›¸ç°¿</span></span>
        <input type="file" id="unifiedInput" class="hidden-input" accept="image/*,.heic" multiple onchange="processUnifiedFiles(this)">
    </div>

    <div id="loading">ğŸš€ æ­£åœ¨é€£æ¥æ™‚å…‰æ©Ÿ...</div>
    <div id="albumGrid" class="grid-container"></div>
    <div id="photoGrid" class="grid-container" style="display:none;"></div>

    <div id="viewerOverlay"><div id="viewerContent"><span id="closeBtn" onclick="closeViewer()">âœ•</span></div></div>

    <div id="floatingMenu" class="floating-menu">
        <div class="fab" onclick="window.scrollTo({top:0, behavior:'smooth'})">TOP</div>
        <div class="fab" onclick="showAlbumList()">è¿”å›<br>åˆ—è¡¨</div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„æ–° GAS ç¶²å€ â˜…â˜…â˜…
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyBsFLlYt415vWiBipXhvycp_OMoQAJZdtfBi85IvQ29sfyCQphy6P0RrhMndpoLT33/exec'; 
        const liffId = '2008678090-ZMqCkYFi'; 
        let allData = { categories: [], allFiles: [] };

        function getPureUserName() { return document.getElementById('userName').innerText.trim(); }
        function isDuplicate(fileName) { return allData.allFiles.some(file => file.name === fileName); }

        // å„ªåŒ–ç‰ˆå£“ç¸®åœ–ç‰‡å‡½å¼ (æ”¯æ´ HEIC)
        async function compressImage(file) {
            // å¦‚æœæ˜¯ HEIC æ ¼å¼ï¼Œå…ˆè½‰æª”
            if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
                try {
                    document.getElementById('globalStatus').innerText += `\næ­£åœ¨è½‰æ› HEIC æ ¼å¼...`;
                    const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.8 });
                    file = blob; // å°‡è½‰å¥½çš„ blob è¦–ç‚ºæ–°æª”æ¡ˆ
                } catch (e) {
                    console.error("HEIC è½‰æ›å¤±æ•—", e);
                    throw new Error("HEIC è½‰æ›å¤±æ•—");
                }
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const maxSide = 1200; // ä¿æŒ 1200px é™åˆ¶
                        if (w > h && w > maxSide) { h *= maxSide / w; w = maxSide; }
                        else if (h > maxSide) { w *= maxSide / h; h = maxSide; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function processUnifiedFiles(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            const status = document.getElementById('globalStatus');
            disableButtons(true);
            
            let successCount = 0;
            let skipCount = 0;

            for (let i = 0; i < files.length; i++) {
                let file = files[i];
                // çµ±ä¸€æª”åç‚º jpg (å³ä½¿åŸæœ¬æ˜¯ heic)
                let baseName = file.name.split('.')[0];
                const fileNameToUpload = baseName + ".jpg";
                
                if (isDuplicate(fileNameToUpload)) {
                    skipCount++;
                    continue;
                }

                status.innerText = `â³ æ­£åœ¨è™•ç† (${i + 1}/${files.length})\n${file.name}`;
                
                try {
                    const data = await compressImage(file);
                    status.innerText = `â¬†ï¸ æ­£åœ¨ä¸Šå‚³ (${i + 1}/${files.length})\n${file.name}`;
                    const res = await uploadToGas(fileNameToUpload, data);
                    if (res.ok) successCount++;
                } catch (e) { 
                    console.error("ä¸Šå‚³å‡ºéŒ¯:", e); 
                    status.innerText += `\nâŒ ${file.name} å¤±æ•—`;
                }
            }

            let msg = `æŠ•ç¨¿å®Œæˆï¼\næˆåŠŸï¼š${successCount} å¼µ`;
            if (skipCount > 0) msg += `\nè·³éé‡è¤‡ï¼š${skipCount} å¼µ`;
            alert(msg);
            
            finishUpload(input);
        }

        async function uploadToGas(name, data) {
            return fetch(gasUrl, { 
                method: "POST", 
                body: JSON.stringify({ fileName: name, fileData: data, userName: getPureUserName() })
            });
        }

        function disableButtons(bool) {
            const btn = document.querySelector('.upload-card-btn');
            if(btn) { 
                btn.style.opacity = bool ? "0.5" : "1"; 
                btn.style.pointerEvents = bool ? "none" : "auto"; 
            }
        }

        function finishUpload(input) {
            document.getElementById('globalStatus').innerText = "";
            disableButtons(false); 
            input.value = ""; 
            // ä¸Šå‚³å¾Œä¸å¼·åˆ¶é‡æ•´ï¼Œå› ç‚ºå¾Œç«¯å°šæœªåˆ†é¡
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById('userName').innerText = profile.displayName;
                    fetchData();
                }
            } catch (err) { 
                console.log("LIFF Error");
                fetchData(); // å³ä½¿ LIFF å¤±æ•—ä¹Ÿå˜—è©¦è¼‰å…¥
            }
        }

        async function fetchData() {
            try {
                // ç¬¬ä¸€æ¬¡è®€å–ä¸å¼·åˆ¶åˆ·æ–°
                const response = await fetch(gasUrl);
                allData = await response.json();
                document.getElementById('loading').style.display = 'none';
                showAlbumList();
            } catch (err) { 
                document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"; 
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿ Google Drive ç¸®åœ–ç¶²å€
        function getThumb(id, size = 'w400') {
            return `https://drive.google.com/thumbnail?id=${id}&sz=${size}`;
        }

        function showAlbumList() {
            document.getElementById('floatingMenu').style.display = 'none';
            document.getElementById('photoGrid').style.display = 'none';
            const albumGrid = document.getElementById('albumGrid');
            albumGrid.style.display = 'grid'; 
            albumGrid.innerHTML = "";
            
            // æ•´ç†åˆ†é¡è³‡æ–™
            const sortedCats = allData.categories.map(cat => {
                const photos = allData.allFiles.filter(p => String(p.category) === String(cat.name));
                // å› ç‚ºå¾Œç«¯å·²ç¶“è½‰æˆ timestampï¼Œé€™è£¡ç›´æ¥æ¯”è¼ƒæ•¸å­—
                const latestDate = photos.length > 0 ? photos[0].date : 0;
                return { ...cat, latestDate, photos };
            });

            sortedCats.sort((a, b) => b.latestDate - a.latestDate);

            sortedCats.forEach(cat => {
                // å¦‚æœè©²åˆ†é¡æ²’ç…§ç‰‡ï¼Œé¡¯ç¤ºé è¨­åœ–æˆ–ä¸é¡¯ç¤º
                if (cat.photos.length === 0) return;

                const coverId = cat.photos[0].id;
                const coverUrl = getThumb(coverId, 'w400');
                
                const div = document.createElement('div');
                div.className = 'card'; 
                div.onclick = () => showPhotos(cat.name);
                div.innerHTML = `<img src="${coverUrl}" loading="lazy"><br>
                                <div style="font-size:12px;margin-top:5px;font-weight:bold;">${cat.name}</div>
                                <div style="font-size:10px;color:#8d6e63;">(${cat.photos.length} é …ç›®)</div>`;
                albumGrid.appendChild(div);
            });
        }

        function showPhotos(catName) {
            document.getElementById('albumGrid').style.display = 'none';
            document.getElementById('floatingMenu').style.display = 'flex';
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.style.display = 'grid'; 
            photoGrid.innerHTML = "";
            
            const filteredFiles = allData.allFiles.filter(p => String(p.category) === String(catName));
            
            filteredFiles.forEach(item => {
                const thumb = getThumb(item.id, 'w600');
                const isVideo = item.type && item.type.includes('video');
                const div = document.createElement('div');
                div.className = 'photo-item'; 
                div.onclick = () => openViewer(item.id, isVideo);
                
                let icon = isVideo ? '<div class="video-label">â–¶</div>' : '';
                div.innerHTML = `${icon}<img src="${thumb}" loading="lazy"><p style="font-size:10px;text-align:center;margin-top:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.name}</p>`;
                photoGrid.appendChild(div);
            });
            window.scrollTo({top: 0, behavior: 'instant'});
        }

        function openViewer(id, isVideo) {
            const content = document.getElementById('viewerContent');
            const overlay = document.getElementById('viewerOverlay');
            content.innerHTML = '<span id="closeBtn" onclick="closeViewer()">âœ•</span>';
            
            if (isVideo) {
                content.innerHTML += `<iframe src="https://drive.google.com/file/d/${id}/preview" width="100%" height="100%" frameborder="0" allow="autoplay" style="background:#000;"></iframe>`;
            } else {
                // æª¢è¦–å¤§åœ–ä½¿ç”¨ w1200
                const bigImg = getThumb(id, 'w1200');
                content.innerHTML += `<img src="${bigImg}" style="max-width:100%; max-height:100%; object-fit:contain; box-shadow: 0 0 20px rgba(0,0,0,0.5);">`;
            }
            overlay.style.display = 'flex'; 
            document.body.style.overflow = 'hidden';
        }

        function closeViewer() { 
            document.getElementById('viewerContent').innerHTML = ""; 
            document.getElementById('viewerOverlay').style.display = 'none'; 
            document.body.style.overflow = 'auto'; 
        }

        initLIFF();
    </script>
</body>
</html>
